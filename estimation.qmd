---
title: "Estimation"
execute: 
  echo: false
html:
    code-fold: true
    code-summary: "Show the code"
---

Using bat call data provided by the state of Montana, we fit a set of multistate multiscale occupancy models to assess the effects of environmental covariates on the probability of bat occupancy. These models are multistate because they consider different levels of bat activity (no bats, few bats, many bats), and multi-scale since each sampled grid cell had multiple sites sampled over a varying number of nights. 

# Model descriptions 

## Null multi-state multi-scale model 

A grid cell $i$ is in one of the three states described (1 = no bats, 2 = few bats, 3 = many bats) given:

$$
z_i \sim \text{Categorical}(\Omega)
$$
where the vector of probabilities for each state follows: 

$$
\Omega = [1-\psi \quad \psi(1-r) \quad \psi r]
$$

where $\psi$ is the probability that a grid cell is occupied by bats, and if occupied, $r$ is the probability that it will be occupied by many bats. In this null model we assume that these probabilities are the same across all grid cells, with no influence of covariates.  

We incorporate the multi-scale component into this model by considering local availability as follows:

$$
a_{i,j} \sim \text{Categorical}[\Theta]
$$
The matrix $\Theta$ gives the probabilities of bats being locally available in each site given their occupancy at the grid cell level. The matrix of probabilities is described as follows: 

$$
\Theta = \begin{bmatrix}
         1 & 0 & 0 \\
         1-\theta_2 & \theta_2 & 0 \\
         \theta_{31} & \theta_{32} & \theta_{33}
         \end{bmatrix}
$$
And the detection model follows for each one of the $k$ surveys on each site $j$ within a grid cell $i$: 

$$
y_{i,j,k} \sim \text{Categorical}(detP)
$$

Where $detP$ is given by: 


$$
detP = \begin{bmatrix}
         1 & 0 & 0 \\
         1-p_2 & p_2 & 0 \\
         p_{31} & p_{32} & p_{33}
         \end{bmatrix}
$$


## M1 

We incorporate covariates at the cell level but local availability and detection remain as in the null model.

$$
\Omega_i = [1-\psi \quad \psi(1-r) \quad \psi r]_i
$$

the probability of occupancy for site $i$, $\psi_i$ is set as: 

$$
\begin{align*}
logit(\psi_i) = \beta_0 + \beta_1 \cdot \text{Elevation} + \beta_2 \cdot \text{Elevation}^2 +
\beta_3 \cdot \text{Temp} + \beta_4 \cdot \text{Temp}^2 + \\
\beta_5 \cdot \text{Physiographic diversity} +
\beta_6 \cdot \text{Precipitation} + \\
\beta_7 \cdot \text{Percent Forest} + \beta_8 \cdot \text{Percent Wetlands}
\end{align*}
$$

What we think could influence whether there are only a few or many bats could be related to caves (karst), percent forest, and ruggedness (physiographic diversity)

$$
logit(r_i) = \beta_0 + \beta_1 \cdot \text{karst} + \beta_2 \cdot \text{Percent Forest} + 
                \beta_3 \cdot \text{Physiographic diversity}
$$

both parameters have region-specific intercepts. 


## M2 

In this third model, we build from M1, and now incorporate site level covariates which include the starting date for the sampling, the duration of sampling period for the site (number of nights), and the site type.

Then, for each site $j$ within a cell $i$, the probability for local availability depends on the site type, starting date, and duration. 

$$
\Theta_{i,j} = \begin{bmatrix}
         1 & 0 & 0 \\
         1-\theta_2 & \theta_2 & 0 \\
         \theta_{31} & \theta_{32} & \theta_{33}
         \end{bmatrix}_{i,j}
$$

$$
logit(\theta) = \beta_0 + \beta_1 \cdot \text{SiteType} + \beta_2 \cdot \text{date} + 
                \beta_3 \cdot \text{date}^2 + \beta_4 \cdot \text{duration}
$$








